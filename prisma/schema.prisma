// Prisma schema file
// https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// ENUMS
// =============================================================================

// T003: User roles for access control
enum Role {
  VISITOR // Unauthenticated or basic access
  TALENT // Actors, comedians, performers
  PROFESSIONAL // Film professionals seeking talent
  COMPANY // Production companies, agencies
  ADMIN // Platform administrators
}

// T004: Profile validation workflow status
enum ValidationStatus {
  PENDING // Awaiting admin review
  APPROVED // Validated and visible
  REJECTED // Rejected by admin
  SUSPENDED // Temporarily disabled
}

// T005: Gender options for talent profiles
enum Gender {
  MALE
  FEMALE
  NON_BINARY
  OTHER
}

// T006: Body physique types
enum Physique {
  SLIM
  AVERAGE
  ATHLETIC
  MUSCULAR
  CURVY
  PLUS_SIZE
}

// Subscription status for paying users
enum SubscriptionStatus {
  NONE
  TRIAL
  ACTIVE
  PAST_DUE
  CANCELLED
  EXPIRED
}

// Payment status for tracking payment lifecycle
enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

// Payment type for categorizing payments
enum PaymentType {
  TALENT_MEMBERSHIP      // Annual membership for talents
  PROFESSIONAL_ACCESS    // Annual access for professionals
  COMPANY_ACCESS         // Annual access for companies
}

// Additional enums for talent attributes
enum HairColor {
  BLACK
  BROWN
  BLONDE
  RED
  GRAY
  WHITE
  OTHER
}

enum EyeColor {
  BROWN
  BLUE
  GREEN
  HAZEL
  GRAY
  OTHER
}

enum HairLength {
  BALD
  SHORT
  MEDIUM
  LONG
}

enum BeardType {
  NONE
  STUBBLE
  SHORT
  MEDIUM
  LONG
  FULL
}

// Legacy availability options for talent profiles
enum AvailabilityType {
  ALWAYS                    // Always available
  SHORT_TERM_1_2_DAYS       // 1-2 days availability
  MEDIUM_TERM_1_2_WEEKS     // 1-2 weeks availability
  LONG_TERM_1_4_MONTHS      // 1-4 months availability
  WEEKENDS_AND_HOLIDAYS     // Weekends and holidays only
  HOLIDAYS_ONLY             // Holidays only
  WEEKENDS_ONLY             // Weekends only
  EVENINGS                  // Evenings only
  DAYS                      // Daytime only
}

// =============================================================================
// MODELS
// =============================================================================

// T007: Base user model for all user types
model User {
  id        String    @id @default(uuid())
  email     String    @unique
  password  String // Hashed password
  role      Role      @default(VISITOR)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  // Stripe customer reference
  stripeCustomerId String? @unique

  // Migration tracking (WordPress user ID)
  legacyId String? @unique

  // Profile relationships (one-to-one based on role)
  talentProfile       TalentProfile?
  professionalProfile ProfessionalProfile?
  companyProfile      CompanyProfile?

  @@index([email])
  @@index([role])
  @@index([legacyId])
}

// T008-T013: Complete talent profile with all 40+ fields
model TalentProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Migration tracking (WordPress post ID)
  legacyId String? @unique

  // === T008: Basic Info ===
  firstName   String
  lastName    String
  gender      Gender
  ageRangeMin Int // Playable age range minimum
  ageRangeMax Int // Playable age range maximum
  dateOfBirth DateTime? // Actual DOB (premium field)
  birthPlace  String? // Place of birth (legacy field)
  photo       String? // Primary headshot URL

  // === T009: Physical Attributes ===
  height           Int? // Height in centimeters
  physique         Physique?
  ethnicAppearance String? // Free text for casting descriptions
  hairColor        HairColor?
  eyeColor         EyeColor?
  hairLength       HairLength?

  // === T010: Unique Traits ===
  beardType         BeardType?
  hasTattoos        Boolean    @default(false)
  hasScars          Boolean    @default(false)
  tattooDescription String? // Description if hasTattoos is true
  scarDescription   String? // Description if hasScars is true

  // === T011: Skills Arrays (PostgreSQL arrays) ===
  languages          String[] // e.g., ["Arabic", "English", "French"]
  accents            String[] // e.g., ["British", "American", "Gulf Arabic"]
  athleticSkills     String[] // e.g., ["Swimming", "Martial Arts", "Horse Riding"]
  musicalInstruments String[] // e.g., ["Piano", "Guitar", "Oud"]
  performanceSkills  String[] // e.g., ["Stand-up Comedy", "Improvisation", "Voice Acting"]
  danceStyles        String[] // e.g., ["Contemporary", "Hip Hop", "Traditional"]

  // === T012: Media and Availability ===
  photos            String[] // Array of photo URLs (max 10, first is primary)
  videoUrls         String[] // Array of embedded video URLs (YouTube/Vimeo)
  presentationVideo String? // Video introduction URL
  showreel          String? // Demo reel URL
  hasShowreel       Boolean  @default(false)
  isAvailable       Boolean  @default(true)
  availabilityTypes AvailabilityType[] // Multi-select availability options
  dailyRate         Decimal? @db.Decimal(10, 2) // Rate in local currency
  rateNegotiable    Boolean  @default(true)
  imdbUrl           String? // IMDB profile link

  // Subscription (membership)
  subscriptionStatus   SubscriptionStatus @default(NONE)
  subscriptionEndsAt   DateTime?
  stripeSubscriptionId String? @unique

  // === T013: Validation and Visibility ===
  validationStatus ValidationStatus @default(PENDING)
  validatedAt      DateTime?
  validatedBy      String? // Admin user ID who validated
  rejectionReason  String? // Reason if rejected
  isPublic         Boolean          @default(true)
  bio              String?          @db.Text // Long text biography
  location         String? // City/region
  contactEmail     String? // Contact email (premium field)
  contactPhone     String? // Contact phone (premium field)
  portfolio        String[] // Additional portfolio URLs
  socialMedia      Json? // JSON object for social links

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Collections relation
  collections CollectionTalent[]

  // Contact requests relation
  contactRequests ContactRequest[]

  // === T016: Indexes for filtering ===
  @@index([gender])
  @@index([ageRangeMin, ageRangeMax])
  @@index([validationStatus])
  @@index([isPublic])
  @@index([isAvailable])
  @@index([location])
  @@index([physique])
  @@index([subscriptionStatus])
  @@index([createdAt])
  @@index([legacyId])
}

// T014: Professional profile for film industry professionals
model ProfessionalProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Professional details
  firstName    String
  lastName     String
  profession   String // e.g., "Casting Director", "Film Director", "Producer"
  company      String? // Associated company name
  accessReason String? @db.Text // Why they need access to talent database
  phone        String?

  // Email verification
  emailVerified       Boolean   @default(false)
  verificationToken   String?   @unique
  verificationExpires DateTime?

  // Validation
  validationStatus ValidationStatus @default(PENDING)
  validatedAt      DateTime?
  validatedBy      String?
  rejectionReason  String?

  // Subscription
  subscriptionStatus   SubscriptionStatus @default(NONE)
  subscriptionEndsAt   DateTime?
  stripeSubscriptionId String? @unique

  // Contact (verified professionals only)
  contactEmail String?
  contactPhone String?
  website      String?

  // Terms acceptance
  termsAcceptedAt DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([validationStatus])
  @@index([profession])
  @@index([subscriptionStatus])
  @@index([verificationToken])
}

// T015: Company profile for production companies and agencies
model CompanyProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Company details
  companyName  String
  industry     String? // e.g., "Film Production", "TV Broadcasting", "Talent Agency"
  description  String? @db.Text
  website      String?
  contactEmail String
  contactPhone String?
  address      String?
  city         String?
  country      String?

  // Email verification
  emailVerified       Boolean   @default(false)
  verificationToken   String?   @unique
  verificationExpires DateTime?

  // Verification
  validationStatus   ValidationStatus @default(PENDING)
  validatedAt        DateTime?
  validatedBy        String?
  rejectionReason    String?
  businessLicenseUrl String? // Uploaded business license for verification
  isVerifiedCompany  Boolean          @default(false)

  // Subscription
  subscriptionStatus   SubscriptionStatus @default(NONE)
  subscriptionEndsAt   DateTime?
  stripeSubscriptionId String? @unique

  // Terms acceptance
  termsAcceptedAt DateTime?

  // Team members
  members CompanyMember[]

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([validationStatus])
  @@index([industry])
  @@index([city])
  @@index([verificationToken])
}

// Company member status for team invitations
enum CompanyMemberStatus {
  PENDING  // Invitation sent, not yet accepted
  ACTIVE   // Member has accepted and is active
  INACTIVE // Member deactivated
}

// Company member role within the company
enum CompanyMemberRole {
  ADMIN  // Can manage team, edit company profile
  MEMBER // Can access talent database
}

// T016: Company team member for multi-user company accounts
model CompanyMember {
  id        String @id @default(uuid())
  companyId String
  company   CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)

  // Member details
  email     String
  firstName String?
  lastName  String?

  // User link (null until invitation accepted)
  userId String?

  // Invitation
  inviteToken   String?   @unique
  invitedAt     DateTime  @default(now())
  invitedBy     String?   // User ID of who sent the invite

  // Status and role
  status CompanyMemberStatus @default(PENDING)
  role   CompanyMemberRole   @default(MEMBER)

  // Timestamps
  acceptedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  @@unique([companyId, email])
  @@index([email])
  @@index([status])
  @@index([inviteToken])
}

// Payment record for tracking all payments
model Payment {
  id     String @id @default(uuid())
  userId String

  // Stripe references
  stripeSessionId    String  @unique // Checkout session ID
  stripePaymentIntent String? // Payment intent ID (set after completion)
  stripeCustomerId   String? // Customer ID for future reference
  stripeInvoiceId    String? // Invoice ID if generated

  // Payment details
  paymentType PaymentType
  amount      Int            // Amount in smallest currency unit (cents/centimes)
  currency    String         @default("mad") // ISO currency code
  status      PaymentStatus  @default(PENDING)

  // Subscription period
  periodStart DateTime? // Subscription period start
  periodEnd   DateTime? // Subscription period end

  // Metadata
  description String?
  metadata    Json?    // Additional Stripe metadata

  // Timestamps
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId])
  @@index([stripeSessionId])
  @@index([status])
  @@index([paymentType])
  @@index([createdAt])
}

// =============================================================================
// MESSAGING MODELS
// =============================================================================

// Conversation between two users
model Conversation {
  id           String    @id @default(uuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Participants (exactly two users per conversation)
  participants ConversationParticipant[]
  messages     Message[]

  @@index([updatedAt])
}

// Join table for conversation participants
model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String

  // When user joined the conversation
  joinedAt       DateTime     @default(now())

  @@unique([conversationId, userId])
  @@index([userId])
  @@index([conversationId])
}

// Message within a conversation
model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  senderId       String
  content        String       @db.Text
  readAt         DateTime?
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
  @@index([conversationId, createdAt])
}

// =============================================================================
// COLLECTION MODELS
// =============================================================================

// Talent collection for organizing talents into project-based lists
model Collection {
  id          String   @id @default(uuid())
  name        String
  description String?  @db.Text
  ownerId     String   // User who owns this collection

  // Timestamps
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  talents     CollectionTalent[]
  shares      CollectionShare[]

  @@index([ownerId])
  @@index([createdAt])
}

// Join table for collection <-> talent many-to-many relationship
model CollectionTalent {
  id             String        @id @default(uuid())
  collectionId   String
  collection     Collection    @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  talentProfileId String
  talentProfile  TalentProfile @relation(fields: [talentProfileId], references: [id], onDelete: Cascade)

  // When talent was added to collection
  addedAt        DateTime      @default(now())

  @@unique([collectionId, talentProfileId])
  @@index([collectionId])
  @@index([talentProfileId])
}

// Shareable link for a collection
model CollectionShare {
  id           String      @id @default(uuid())
  collectionId String
  collection   Collection  @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  token        String      @unique // Secure random token for access
  expiresAt    DateTime?   // Optional expiry date

  // Timestamps
  createdAt    DateTime    @default(now())

  @@index([token])
  @@index([collectionId])
  @@index([expiresAt])
}

// =============================================================================
// NOTIFICATION MODELS
// =============================================================================

// Notification types for categorizing notifications
enum NotificationType {
  MESSAGE
  COLLECTION_SHARE
  SYSTEM
  CONTACT_REQUEST
}

// User notifications
model Notification {
  id          String           @id @default(uuid())
  type        NotificationType
  title       String
  content     String           @db.Text
  actionLink  String?          // URL to navigate on click

  // Recipient
  recipientId String

  // Optional sender (for user-triggered notifications)
  senderId    String?

  // Status
  readAt      DateTime?

  // Timestamps
  createdAt   DateTime         @default(now())

  @@index([recipientId])
  @@index([recipientId, readAt])
  @@index([type])
  @@index([createdAt])
}

// User notification preferences
model NotificationPreference {
  id        String  @id @default(uuid())
  userId    String  @unique

  // Global settings
  enabled   Boolean @default(true)

  // Channel preferences (JSON)
  // { inApp: true, email: true }
  channels  Json    @default("{\"inApp\": true, \"email\": true}")

  // Event type preferences (JSON)
  // { MESSAGE: { inApp: true, email: true }, ... }
  eventTypes Json   @default("{}")

  // Email rate limiting
  // { eventType: timestamp }
  lastEmailSentAt Json @default("{}")

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

// =============================================================================
// PROFILE VIEW TRACKING (Privacy-conscious aggregate only)
// =============================================================================

// Profile view aggregate counter for talents
// Stores daily aggregate counts - no individual viewer data
model ProfileView {
  id              String   @id @default(uuid())
  talentProfileId String
  date            DateTime @db.Date  // Date of views (daily aggregation)
  viewCount       Int      @default(0)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([talentProfileId, date])
  @@index([talentProfileId])
  @@index([date])
  @@index([talentProfileId, date])
}

// =============================================================================
// ACCESS LOGGING
// =============================================================================

// Access log for tracking premium data access attempts
model AccessLog {
  id        String   @id @default(uuid())
  userId    String   // User attempting access

  // Resource being accessed
  resourceType String   // e.g., "talent_profile", "contact_info"
  resourceId   String   // ID of the resource

  // Access details
  action       String   // e.g., "view", "download", "export"
  granted      Boolean  // Whether access was granted
  reason       String?  // Reason for denial if not granted

  // Context
  ipAddress    String?  // For audit trail
  userAgent    String?  // Browser/client info

  // Timestamps
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([resourceType, resourceId])
  @@index([granted])
  @@index([createdAt])
}

// =============================================================================
// CONTACT REQUEST MODELS
// =============================================================================

// Contact request status state machine
enum ContactRequestStatus {
  PENDING   // Awaiting talent response
  APPROVED  // Talent approved, contact info revealed
  DECLINED  // Talent declined
  EXPIRED   // Request expired (future enhancement)
}

// Project type for categorizing contact requests
enum ProjectType {
  FILM
  TV_SERIES
  COMMERCIAL
  THEATER
  VOICE_OVER
  MODELING
  OTHER
}

// Contact request from professional/company to talent
model ContactRequest {
  id        String               @id @default(uuid())
  status    ContactRequestStatus @default(PENDING)

  // Requester (professional or company user)
  requesterId String

  // Target talent
  talentProfileId String
  talentProfile   TalentProfile @relation(fields: [talentProfileId], references: [id], onDelete: Cascade)

  // Request details
  projectType   ProjectType
  projectName   String?         // Optional project name
  purpose       String          @db.Text  // Why they want to contact
  message       String?         @db.Text  // Optional personal message

  // Response details
  declineReason String?         // Talent's reason if declined

  // Timestamps
  createdAt     DateTime        @default(now())
  respondedAt   DateTime?       // When talent responded
  expiresAt     DateTime?       // Optional expiry date

  // Indexes
  @@index([requesterId])
  @@index([talentProfileId])
  @@index([status])
  @@index([createdAt])
  @@index([requesterId, status])
  @@index([talentProfileId, status])
}
